---
title: "**Supplementary Online Content**"
subtitle: 'Antithrombotic Regimens for the Prevention of Major Adverse Cardiac Events in Patients with Chronic Coronary Syndrome - A Systematic Review and Network Meta-Analysis'
output:
  pdf_document: 
    keep_tex: true 
fontsize: 12pt
header-includes: 
# https://tex.stackexchange.com/questions/526101/how-to-customize-header-with-rmarkdown
  - \usepackage{titling}
  - \pretitle{\begin{center}\huge\bfseries}
  - \posttitle{\end{center}} 
  
# https://stackoverflow.com/questions/25849814/rstudio-rmarkdown-both-portrait-and-landscape-layout-in-a-single-pdf
  - \usepackage{pdflscape} 
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  
# https://tex.stackexchange.com/questions/84506/landscape-mode-causes-a-blankpage
  - \usepackage{geometry}
  
# https://www.overleaf.com/learn/latex/Table_of_contents
  - \renewcommand\contentsname{Table of Contents}
  
# https://tex.stackexchange.com/questions/28392/how-to-suppress-caption-numbering-in-a-table
  - \usepackage{caption}
  - \captionsetup[table]{labelformat=empty}
---

\newpage 
\tableofcontents 
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.align = "center"
)
```

```{r message=FALSE, warning=FALSE, results="hide"}
# Ensures the package "pacman" is installed
if (!require("pacman")) install.packages("pacman")

# Install/Load packages
pacman::p_load("rio",
               "Hmisc",
               "here",
               "dplyr",
               "tidyr",
               "multinma",
               "metafor",
               "ggdist",
               "posterior",
               "janitor",
               "ggplot2",
               "MetBrewer",
               "patchwork",
               "kableExtra",
               "igraph",
               "purrr",
               "stringr",
               "fs")

# Ensure packages are loaded following what's stored in renv's lockfile
renv::restore()

defs = rio::import(here::here("data", "mace_safety_definitions.xlsx")) 

ef = rio::import(here::here("data", "effect_modifiers.xlsx")) 

# Load multiple datasets for network plots
# https://dominicroye.github.io/en/2019/import-excel-sheets-with-r/

rgx = "(?<=data(.{1})).+?(?=.csv)"

data = 
  fs::dir_ls(path = here::here("output", "data"),
       regexp = "csv") |> 
  purrr::map_df(utils::read.csv,
                .id = "outcome") |> 
  dplyr::mutate(outcome = stringr::str_extract(string = outcome,
                                               pattern = rgx)) |> 
  dplyr::mutate(treatment = dplyr::case_when(
      treatment == "AAS" ~ "ASA",
      treatment == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      treatment == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      treatment == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      treatment == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      treatment == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg",
      treatment == "60_Ticagrelor" ~ "ASA + Ticagrelor 60mg",
      treatment == "90_Ticagrelor" ~ "ASA + Ticagrelor 90mg",
      treatment == "Pooled_Ticagrelor" ~ "ASA + Pooled Ticagrelor"))

# Load RoB2 and CINEMA

rob = rio::import(here::here("data", "rob2.xlsx")) |> 
  dplyr::mutate(outcome =
                  # Unify all safety outcomes as one, "safety"
                  ifelse(outcome %nin% c("AMI",
                                         "Isch_Stroke",
                                         "Cardio_Death",
                                         "Any_Death",
                                         "MACE_ITT"),
                         "safety", outcome)) |> 
  dplyr::mutate(treatment1 = dplyr::case_when(
      treatment1 == "AAS" ~ "ASA",
      treatment1 == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      treatment1 == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      treatment1 == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      treatment1 == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      treatment1 == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg",
      treatment1 == "60_Ticagrelor" ~ "ASA + Ticagrelor 60mg",
      treatment1 == "90_Ticagrelor" ~ "ASA + Ticagrelor 90mg",
      treatment1 == "Pooled_Ticagrelor" ~ "ASA + Pooled Ticagrelor",
      treatment1 == "ASA + Prasugrel 10mg or Clopidogrel 75mg" ~ 
        "ASA + Prasugrel 10mg or Clopidogrel 75mg")) |> 
  dplyr::mutate(treatment2 = dplyr::case_when(
      treatment2 == "AAS" ~ "ASA",
      treatment2 == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      treatment2 == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      treatment2 == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      treatment2 == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      treatment2 == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg",
      treatment2 == "60_Ticagrelor" ~ "ASA + Ticagrelor 60mg",
      treatment2 == "90_Ticagrelor" ~ "ASA + Ticagrelor 90mg",
      treatment2 == "Pooled_Ticagrelor" ~ "ASA + Pooled Ticagrelor")) |> 
  dplyr::mutate("Study, Comparison" = stringr::str_c(study, ", ",
                                            treatment1, " vs.", treatment2))

cinema = rio::import(here::here("data", "cinema.xlsx")) 

# Load models
load(here::here("output", "fits", "pooled_MACE_FE.RData"))
load(here::here("output", "fits", "pooled_safety_FE.RData"))

load(here::here("output", "fits", "not_pooled_MACE_FE.RData"))
load(here::here("output", "fits", "not_pooled_safety_FE.RData"))

load(here::here("output", "fits", "pooled_AMI_FE.RData"))
load(here::here("output", "fits", "pooled_Isch_Stroke_FE.RData"))
load(here::here("output", "fits", "pooled_Any_Death_FE.RData"))
load(here::here("output", "fits", "pooled_Cardio_Death_FE.RData"))
```

\newpage


# Systematic Review

## Search Strategies

```{r}
data.frame(
  "Database" = c("PubMed", "EMBASE", "CENTRAL"),
  "Terms" = c('(“Arteriosclerosis”[mh] OR “Angina, Stable”[mh]) AND (“Platelet Aggregation Inhibitors” [Mesh] OR “Dual Anti-Platelet Therapy” [Mesh] OR “Aspirin”[mh] OR “Clopidogrel”[mh] OR “Factor Xa Inhibitors”[mh] OR “apixaban”[Supplementary Concept] OR “edoxaban”[Supplementary Concept] OR “Rivaroxaban”[mh] OR “Purinergic P2Y Receptor Antagonists”[mh] OR “Ticagrelor”[mh] OR “Prasugrel”[tw] OR “Vorapaxar”[tw]) AND (“Myocardial Infarction”[mh] OR “Angina, Unstable”[mh] OR “Stroke”[Mesh] OR Death, Sudden, Cardiac [Mesh] OR “Myocardial Revascularization”[mh] OR “Major Adverse Cardiac Event”[tw] OR “Hemorrhage”[mh])',
              "(‘atherosclerosis’/exp OR ‘stable angina pectoris’/exp) AND (‘antithrombocytic agent’/exp OR ‘dual antiplatelet therapy’/exp OR ‘acetylsalicylic acid’/mj OR ‘clopidogrel’/mj OR ‘blood clotting factor 10a inhibitor’/exp OR ‘apixaban’/mj OR ‘edoxaban’/mj OR ‘rivaroxaban’/mj OR ‘purinergic p2y receptor antagonist’/exp OR ‘ticagrelor’/mj OR ‘prasugrel’/mj OR ‘vorapaxar’/mj) AND (‘heart infarction’/mj OR ‘unstable angina pectoris’/mj OR ’cerebrovascular accident’/mj OR ‘heart muscle revascularization’/exp OR ‘major adverse cardiac event’/mj OR ‘bleeding’/exp) ",
              "/#1 MeSH descriptor: [Arteriosclerosis] explode all trees 11018
/#2 MeSH descriptor: [Angina, Stable] explode all trees 360
/#3 #1 OR #2 11264
/#4 MeSH descriptor: [Platelet Aggregation Inhibitors] explode all trees 4016
/#5 MeSH descriptor: [Dual Anti-Platelet Therapy] explode all trees 45
/#6 MeSH descriptor: [Aspirin] explode all trees 6018
/#7 MeSH descriptor: [Clopidogrel] explode all trees 2074
/#8 MeSH descriptor: [Factor Xa Inhibitors] explode all trees 572
/#9 (apixaban):ti,ab,kw 984
/#10 (edoxaban):ti,ab,kw 598
/#11 MeSH descriptor: [Rivaroxaban] explode all trees 568
/#12 MeSH descriptor: [Purinergic P2Y Receptor Antagonists] explode all trees 359
/#13 MeSH descriptor: [Ticagrelor] explode all trees 786
/#14 #4 OR #5 OR #6 OR #7 OR #8 OR #9 OR #10 OR #11 OR #12 OR #13 10962
/#15 MeSH descriptor: [Myocardial Infarction] explode all trees 11333
/#16 MeSH descriptor: [Angina, Unstable] explode all trees 1138
/#17 MeSH descriptor: [Stroke] explode all trees 10342
/#18 MeSH descriptor: [Death, Sudden, Cardiac] explode all trees 635
/#19 MeSH descriptor: [Myocardial Revascularization] explode all trees 9254
/#20 (Major Adverse Cardiac Event):ti,ab,kw 2745
/#21 MeSH descriptor: [Hemorrhage] explode all trees 14754
/#22 #15 OR #16 OR #17 OR #18 OR #19 OR #20 OR #21 43672
/#23 #3 AND #14 AND #22 
")
) |> 
  kableExtra::kbl(booktabs = F) |> 
  kableExtra::column_spec(1, bold = T) |> 
  kableExtra::kable_styling(latex_options = "striped",
                            # striped doesn't work with full_width :(
                            # https://github.com/haozhu233/kableExtra/issues/427
                            full_width = T,
                            font_size = 9.3)
```

\newpage

## eTable 1: Trial definitions

```{r}
defs |> 
  kableExtra::kbl(booktabs = F) |>
  kableExtra::column_spec(1, bold = T) |> 
  kableExtra::kable_styling(latex_options = "striped",
                            # striped doesn't work with full_width :(
                            # https://github.com/haozhu233/kableExtra/issues/427
                            full_width = T,
                            font_size = 9.5) 
```

\footnotesize

\* Moderate bleeding is defined as bleeding requiring blood transfusion, but not
resulting in hemodynamic compromise, and severe bleeding is defined as either an
intracerebral hemorrhage or bleeding resulting in substantial hemodynamic
compromise requiring treatment according to the GUSTO criteria.

** BARC type bleeding of 3 is defined as clinical, laboratory, and/or imaging
evidence of bleeding with healthcare responses, as listed: Any transfusion with
overt bleeding; Overt bleeding plus hemoglobin (Hb) drop >=3 to <5 g/dI (provided
Hb drop is related to bleeding); Overt bleeding plus Hb drop >=5 g/dl; Cardiac
tamponade; Bleeding requiring surgical intervention for control; Bleeding
requiring intravenous vasoactive drugs; Intracranial hemorrhage; Intraocular
bleed compromising vision.

*** TIMI major bleeding is defined as any intracranial bleeding (excluding
microhemorrhages <10 mm evident only on gradient-echo MRI), or clinically overt
signs of hemorrhage associated with a drop in hemoglobin of >=5 g/dL or a >=15%
absolute decrease in haematocrit, or a fatal bleeding (bleeding that directly
results in death within 7 d).

\normalsize


## eFigure 1: Effect Modifiers

```{r fig.width=8, fig.height=6}
ef |> 
  dplyr::mutate(combo = stringr::str_c(study, ": ", treatment)) |> 
  tidyr::pivot_longer(cols = c(female:multivessel)) |> 
  dplyr::mutate(name = dplyr::case_when(
    name == "female" ~ "F",
    name == "hypertension" ~ "HTN",
    name == "diabetes" ~ "D",
    name == "smoker" ~ "S",
    name == "pci" ~ "PCI",
    name == "cagb" ~ "CAGB",
    name == "multivessel" ~ "MVD"),
    
    name = factor(name, levels = c(
      "F",
      "HTN",
      "D",
      "S",
      "PCI",
      "CAGB",
      "MVD"
    ))) |> 
  ggplot() +
  aes(x = name, y = combo, fill = value, label = value) + 
  geom_tile() +
  geom_text(size = 4, aes(color = value < 50),
            show.legend = F) +
  scale_color_manual(values = c("white", "black")) +
  scale_fill_gradientn("Proportion\n",
                       breaks=c(0, 50, 100),
                       labels = c("0%", "50%","100%"),
                       limits = c(0, 100),
                       colors = MetBrewer::met.brewer("Tam")) +
  scale_x_discrete(expand = c(0,0), position = "top") +
  scale_y_discrete(expand = c(0,0)) +
  labs(x = NULL, y = NULL) +
  theme(plot.title.position = "plot",
        legend.position = "bottom",
        plot.title = element_text(size = 16),
        strip.text.x = element_text(size = 12,
                                    face="bold"),
        axis.text.x= element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        legend.title = element_text(size=12),
        legend.text = element_text(size=12),
        plot.margin = margin(40, 40, 40, 40))
```

Heatmap on the proportions of potential efffect modifiers across included
studies and treatment arms. Each row corresponds to a specific study and
treatment arm combination. Each column corresponds to a specific effect modifier.
The exact proportion is depicted by both filled color and the number on top in 
each cell.


Abbreviations: F, female; HTN, hypertension; D, diabetes; S, smoker; PCI,
percutaneous coronary intervention; CAGB, coronary artery bypass graft; MVD,
multivessel disease.

\newpage

## eTable 2: Risk of Bias Assessment

Risk of bias for domain-level as well as overall judgements. 

D1: bias arising from randomisation process; D2: bias arising from
deviations from intended interventions; D3: bias due to missing outcome data;
D4: bias in measurement of the outcome; D5: bias in selection of the reported
result.



```{r}

rob$`D1` = kableExtra::cell_spec(
  rob$`D1`,
  color = "white",
  background = ifelse(rob$`D1` == "Low",
                      "#5CA881", "#E7B03C")
)

rob$`D2` = kableExtra::cell_spec(
  rob$`D2`,
  color = "white",
  background = ifelse(rob$`D2` == "Low",
                      "#5CA881", "#E7B03C")
)

rob$`D3` = kableExtra::cell_spec(
  rob$`D3`,
  color = "white",
  background = ifelse(rob$`D3` == "Low",
                      "#5CA881", "#E7B03C")
)

rob$`D4` = kableExtra::cell_spec(
  rob$`D4`,
  color = "white",
  background = ifelse(rob$`D4` == "Low",
                      "#5CA881", "#E7B03C")
)

rob$`D5` = kableExtra::cell_spec(
  rob$`D5`,
  color = "white",
  background = ifelse(rob$`D5` == "Low",
                      "#5CA881", "#E7B03C")
)

rob$`Overall` = kableExtra::cell_spec(
  rob$`Overall`,
  color = "white",
  background = ifelse(rob$`Overall` == "Low",
                      "#5CA881", "#E7B03C")
)


tab_fun_rob = function(name){
  
rob |> 
  dplyr::filter(outcome == name) |> 
  dplyr::select("Study, Comparison", D1:Overall) |> 
  kableExtra::kbl(booktabs = T, escape = F) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
  
}
```

### MACE

```{r}
tab_fun_rob(name = "MACE_ITT")
```

### Bleeding

```{r}
tab_fun_rob(name = "safety")
```


\newpage

### Acute Myocardial Infarction

```{r}

tab_fun_rob("AMI") 
```

### Ischemic Stroke

```{r}
tab_fun_rob("Isch_Stroke") 
```

### All-cause Mortality

```{r}

tab_fun_rob("Any_Death") 
```

### Cardiovascular Mortality

```{r}

tab_fun_rob("Cardio_Death") 
```

\newpage

\blandscape

# Pooled Ticagrelor Networks: MACE and Bleeding Outcomes

## League Tables

### eTable 3: Median and 95% Credible Intervals

```{r}
# regex code to apply below inspired by:
# https://twitter.com/dmphillippo/status/1510922243693551616?s=21
rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

# extract posterior draws of all possible treatment effect comparisons
MACE_draws = multinma::relative_effects(network_MACE_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

safety_draws = multinma::relative_effects(network_safety_pooled_FE,
                               summary = F,
                               all_contrasts = T)

MACE_matrix = 
  # Data wrangle to facilitate manipulation of these draws
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  # Calculate median and 95% highest density interval (HDI)
  ggdist::median_hdi(.width = 0.95) |> 
  # Exponentiate because results are in the log scale 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  # Data wrangle 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# similar code as above, but for the Bleeding outcome
safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "AAS_10_Prasugrel" = NA,
            "AAS_75_Clopidogrel" = NA,
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  # Transpose it so we can combine the MACE matrix with this in a league table 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 6))
  )
  ) |> 
  as.matrix()

# Put both matrices together now (league table)

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame
new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Hazard ratios (95% credible interval) for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).

\newpage

### eTable 4: Posterior Probabilities of Hazard Ratio < 1.0

```{r}
# Similar code as code chunk above, but now for a league table showing
# the posterior probability < 1.0 HR

MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  # Posterior Probability (%) < 1.0 HR
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "AAS_10_Prasugrel" = NA,
            "AAS_75_Clopidogrel" = NA,
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
    # Posterior Probability (%) < 1.0 HR
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 6))
  )
  ) |> 
  as.matrix()

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```



Posterior probabilities (%) of hazard ratio < 1.0 for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 1.0 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).

\newpage

### eTable 5: Posterior Probabilities of Hazard Ratio < 0.8

```{r}
# Similar code as code chunk above, but now for a league table showing
# the posterior probability < 0.8 HR

MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  # Posterior Probability (%) < 0.8 HR
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "AAS_10_Prasugrel" = NA,
            "AAS_75_Clopidogrel" = NA,
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
    # Posterior Probability (%) < 1.0 HR
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 6))
  )
  ) |> 
  as.matrix()

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 0.8 for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 0.8 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).

\newpage

### eTable 6: Posterior Probabilities of Hazard Ratio > 1.25

```{r}
# Similar code as code chunk above, but now for a league table showing
# the posterior probability > 1.25 HR

MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  # Posterior Probability (%) > 1.25 HR
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "AAS_10_Prasugrel" = NA,
            "AAS_75_Clopidogrel" = NA,
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
    # Posterior Probability (%) > 1.25 HR
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 6))
  )
  ) |> 
  as.matrix()

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio > 1.25 for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is above 1.25.

\newpage

### eTable 7: Posterior Probabilities of Hazard Ratio within the ROPE

```{r}
# Similar code as code chunk above, but now for a league table showing
# the posterior probability within the region of practical equivalence (ROPE),
# i.e. between 0.8 and 1.25 HR

MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  # Posterior Probability (%) within ROPE
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "AAS_10_Prasugrel" = NA,
            "AAS_75_Clopidogrel" = NA,
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
    # Posterior Probability (%) within ROPE
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 6))
  )
  ) |> 
  as.matrix()

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```


Posterior probabilities (%) of hazard ratio within the region of practical equivalence
(ROPE), ie, between 0.80 and 1.25, for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is within the ROPE.

\elandscape


## eFigure 2: Ranks with Uncertainty 

```{r}

# Regex code to apply below
rxp = "^rank\\[(.+)]$" 

# Generate posterior draws of treatment effect ranks
ranks_MACE = 
  multinma::posterior_ranks(network_MACE_pooled_FE, lower_better = T,
                          summary = F)

ranks_safety = 
  multinma::posterior_ranks(network_safety_pooled_FE, lower_better = T,
                          summary = F)

# Data wrangle to combine both MACE and Bleeding draws
ranks_MACE$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "MACE") |> 
  dplyr::bind_rows(
    ranks_safety$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "Bleeding")
  ) |> 
  # Rename and re-order treatment effect
  dplyr::mutate(name = dplyr::case_when(
      name == "AAS" ~ "ASA",
      name == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      name == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      name == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      name == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      name == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg",
      name == "Pooled_Ticagrelor" ~ "Pooled Ticagrelor"),
      
      name = factor(name, levels = rev(c("ASA + Prasugrel 10mg",
                                     "Clopidogrel 75mg",
                                     "ASA + Rivaroxaban 2.5mg",
                                     "ASA + Clopidogrel 75mg",
                                     "Pooled Ticagrelor",
                                     "Rivaroxaban 5mg",
                                     "ASA"))),
    outcome = factor(outcome, levels = c("MACE",
                                         "Bleeding"))) |> 
  
  # Plot!
  
  ggplot() +
  aes(x = value, y = name, fill = name) +
  ggdist::stat_cdfinterval(.width = 0.95,
                       point_interval = ggdist::median_qi) +
  scale_fill_manual(values= MetBrewer::met.brewer("Greek", 7)) +
  scale_x_continuous(breaks = seq(1, 7, 1)) +
  labs(x = "Rank", y = NULL) +
  facet_wrap(~outcome, scales = "free_x") +
  multinma::theme_multinma() +
  theme(legend.position = "none")


```

Marginal posterior distributions for the rank of each treatment. Left panel depicts
ranks for MACE, while right panel for the Bleeding outcome. In each panel,
there are a point estimate, interval bar, and bar plot for each treatment (Y-axis).
The point estimate represents the median rank. The interval bar shows the 95%
credible (quantile) interval of the underlying marginal posterior distribution.
Lastly, the bar plot shows the cumulative distribution function (CDF).  



# Separate Dosages Ticagrelor Networks: MACE and Bleeding Outcomes

```{r}
# From now on, all code has been previously commented/explained either in this
# file or other files. Thus, I won't comment each step again
```


## eFigure 3: Network Plot


```{r}

wrangle_forest_fun = function(network_object,
                              outcome_name){
  
sucra = 
  multinma::posterior_rank_probs(network_object, 
                                 lower_better = T,
                                 sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::rename("name" = parameter)

draws = multinma::relative_effects(network_object,
                                   summary = F)

draws_pivot = 
  draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d["))

CIs = 
  draws_pivot |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::select(name:.upper) |> 
  dplyr::mutate(interval = paste0(round(exp(value),2),
                                  " [",
                                  round(exp(.lower), 2),
                                  ", ",
                                  round(exp(.upper), 2),
                                  "]")
  )

probs = 
  draws_pivot |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr08 = mean(value < log(0.8)),
                   pr1_lower = mean(value < log(1)),
                   pr1_greater = mean(value > log(1)),
                   pr125 = mean(value > log(1/0.8)),
                   prrope = mean(value > log(0.8) & value < log(1/0.8))) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(dplyr::across(pr08:prrope, ~round(100*.,1)))


both = 
  dplyr::left_join(CIs, sucra) |>
  dplyr::left_join(probs) |>
  dplyr::mutate(
    name = dplyr::case_when(
      name == "d[AAS]" ~ "ASA",
      name == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      name == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      name == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      name == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      name == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg",
      name == "d[60_Ticagrelor]" ~ "Ticagrelor 60mg",
    name == "d[90_Ticagrelor]" ~ "Ticagrelor 90mg"),
    
    outcome = outcome_name
    )

return(both)
}

altogether = 
  wrangle_forest_fun(network_MACE_not_pooled_FE,
                   outcome_name = "MACE") |> 
  dplyr::bind_rows(
    wrangle_forest_fun(network_safety_not_pooled_FE,
                       outcome_name = "safety")
    ) |> 
  dplyr::arrange(sucra, outcome)
  
forest_fun = function(){
  
   x = 
     base::with(altogether,
              metafor::forest(x = value,
                    ci.lb = .lower,
                    ci.ub = .upper,
                    ylim = c(-2.5, 16.5),
                    rows= c(-2:4, 6.5:12.5),
                    xlim = c(-2.5, 4.5),
                    ilab = cbind(interval, pr08, pr1_lower,
                                 pr1_greater, pr125, prrope),
                    ilab.xpos = 1.5+c(0.6, 1.2, 1.5, 1.8, 2.1, 2.4),
                    slab = name,
                    order = desc(outcome),
                    at=log(c(.4, .6, 0.8, 1, 1.25, 2, 4)),
                    refline = log(c(0.8, 1, 1/0.8)), # vertical lines
                    pch = 19, # circles
                    annotate = F, # Remove estimates
                    atransf = exp,
                    psize = 1.4, # Circle size
                    efac=0, # Remove vertical lines at interval bars
                    header="Compared with ASA",
                    xlab = "Hazard Ratio (log scale)",
                    cex = 1,
                    cex.lab = 1) # X axis label font size
  ) 

# ROPE
graphics::rect(xleft = log(0.8), xright = log(1/0.8),
               ybottom = x$ylim[1] - 1, ytop = x$ylim[2] - 2,
               border = NA, # no borders
               col = grDevices::adjustcolor("gray70", alpha.f = 0.4))

# Headers

text(x$xlim[1], x$ylim[2] - 3,
     "MACE",
     font=4, # bold
     pos = 4, # left-align
     cex = 1.3)

text(x$xlim[1], x$ylim[2] - 11.5,
     "Bleeding",
     font=4, # bold
     pos = 4, # left-align
     cex = 1.3)

text((4.05 + 2.55)/2,
     x$ylim[2], 
     "Posterior Probability, %",
     #font=2,
     cex = 1)

# Horizontal line
segments(x0 = 2.55, x1 = 4.05,
         y0 = x$ylim[2] - 0.5, y1 = x$ylim[2] - 0.5)

graphics::text(1.5+c(0.6, 1.2, 1.5, 1.8, 2.1, 2.4),
               x$ylim[2] - 1, cex = 1,
               c("HR [95% CrI]", "< 0.80", "< 1.00",
                 "> 1.00", "> 1.25", "ROPE"))
}

net_fun = function(data_sub){
  
  multinma::set_agd_contrast(data = data_sub,
                               trt_ref = "ASA",
                               study = study,
                               trt = treatment,
                               y = logHR,
                               se = std.err,
                               sample_size = n_patients) |> 
  
  igraph::as.igraph() |> 
    plot(vertex.color = "blue",
         vertex.label.color = "black",
         edge.color = "black",
         layout = igraph::layout.circle,
         vertex.label.dist = 3,
         vertex.size=15,
         vertex.label.cex = 0.8) 
  
}


# pdf(file = here::here("output", "plots", "supplementary",
#                       'forest_not_pooled_primary.pdf'),
#     height=7, width=13)
# 
# forest_fun()
# 
# dev.off()
```

```{r}

net_fun(subset(data, outcome == "MACE_not_pooled"))
# net_fun(subset(data, outcome == "safety_not_pooled")) same network
```

\blandscape

## eFigure 4: Forest Plot

```{r out.width="1\\linewidth"}
# Show previously saved forest plot
knitr::include_graphics(here::here("output", "plots", "supplementary",  
                                   'forest_not_pooled_primary.png'))

```

Left panel: Network of MACE and Bleeding outcomes while separing Ticagrelor's 
dosages.
Right panel: 
Treatment effects compared to ASA on MACE and Bleeding outcomes, ordered according
to underlying SUCRA values. HR below 1.0 favors the experimental treatment.
On the left, treatment names are depicted. In the middle,
forest plot shows each treatment effect median and 95% credible intervals. Gray
area corresponds to the ROPE (from 0.8 to 1.25 HR). On the right, exact effect
sizes along with posterior probabilities are shown. Abbreviations: ROPE, region
of practical equivalence; HR, hazard ratio.

## League Tables

### eTable 8: Median and 95% Credible Intervals

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "60_Ticagrelor",
          "75_Clopidogrel", "90_Ticagrelor", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel")

MACE_draws = multinma::relative_effects(network_MACE_not_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

safety_draws = multinma::relative_effects(network_safety_not_pooled_FE,
                               summary = F,
                               all_contrasts = T)

MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 7))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "90_Ticagrelor" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "90_Ticagrelor" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
             "AAS_10_Prasugrel" = NA,
             "AAS_75_Clopidogrel" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel,
                "90_Ticagrelor" = X90_Ticagrelor) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("AAS_75_Clopidogrel" = rep(NA, 7))
  )
  ) |> 
   # re-arrange column order
  dplyr::select(order) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 8, ncol = 8)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Ticagrelor 60mg", "Clopidogrel 75mg",
            "Ticagrelor 90mg", "ASA + Rivaroxaban 2.5mg",  "ASA + Prasugrel 10mg",
            "ASA + Clopidogrel 75mg")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 8)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Hazard ratios (95% credible interval) for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).

\newpage

### eTable 9: Posterior Probabilities of Hazard Ratio < 1.0

```{r}
MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 7))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "90_Ticagrelor" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "90_Ticagrelor" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
             "AAS_10_Prasugrel" = NA,
             "AAS_75_Clopidogrel" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel,
                "90_Ticagrelor" = X90_Ticagrelor) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("AAS_75_Clopidogrel" = rep(NA, 7))
  )
  ) |> 
   # re-arrange column order
  dplyr::select(order) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 8, ncol = 8)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Ticagrelor 60mg", "Clopidogrel 75mg",
            "Ticagrelor 90mg", "ASA + Rivaroxaban 2.5mg",  "ASA + Prasugrel 10mg",
            "ASA + Clopidogrel 75mg")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 8)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))


```

Hazard ratios (95% credible interval) for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).

\newpage

### eTable 10: Posterior Probabilities of Hazard Ratio < 0.8

```{r}
MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 7))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "90_Ticagrelor" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "90_Ticagrelor" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
             "AAS_10_Prasugrel" = NA,
             "AAS_75_Clopidogrel" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel,
                "90_Ticagrelor" = X90_Ticagrelor) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("AAS_75_Clopidogrel" = rep(NA, 7))
  )
  ) |> 
   # re-arrange column order
  dplyr::select(order) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 8, ncol = 8)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Ticagrelor 60mg", "Clopidogrel 75mg",
            "Ticagrelor 90mg", "ASA + Rivaroxaban 2.5mg",  "ASA + Prasugrel 10mg",
            "ASA + Clopidogrel 75mg")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 8)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))


```

Posterior probabilities (%) of hazard ratio < 0.8 for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 0.8 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).

\newpage

### eTable 11: Posterior Probabilities of Hazard Ratio > 1.25

```{r}
MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 7))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "90_Ticagrelor" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "90_Ticagrelor" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
             "AAS_10_Prasugrel" = NA,
             "AAS_75_Clopidogrel" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel,
                "90_Ticagrelor" = X90_Ticagrelor) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("AAS_75_Clopidogrel" = rep(NA, 7))
  )
  ) |> 
   # re-arrange column order
  dplyr::select(order) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 8, ncol = 8)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Ticagrelor 60mg", "Clopidogrel 75mg",
            "Ticagrelor 90mg", "ASA + Rivaroxaban 2.5mg",  "ASA + Prasugrel 10mg",
            "ASA + Clopidogrel 75mg")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 8)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))


```

Posterior probabilities (%) of hazard ratio < 0.8 for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 0.8 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).

\newpage

### eTable 12: Posterior Probabilities of Hazard Ratio within the ROPE

```{r}
MACE_matrix = 
  MACE_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |>
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 7))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "90_Ticagrelor" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA)
  ) |> 
  as.matrix()


safety_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "90_Ticagrelor" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
             "AAS_10_Prasugrel" = NA,
             "AAS_75_Clopidogrel" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel,
                "90_Ticagrelor" = X90_Ticagrelor) |> 
  dplyr::bind_rows(
    
  safety_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |>
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("AAS_75_Clopidogrel" = rep(NA, 7))
  )
  ) |> 
   # re-arrange column order
  dplyr::select(order) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 8, ncol = 8)
new[upper.tri(new)] = MACE_matrix[upper.tri(MACE_matrix)]
new[lower.tri(new)] = safety_matrix[lower.tri(safety_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Ticagrelor 60mg", "Clopidogrel 75mg",
            "Ticagrelor 90mg", "ASA + Rivaroxaban 2.5mg",  "ASA + Prasugrel 10mg",
            "ASA + Clopidogrel 75mg")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 8)) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio within the region of practical equivalence
(ROPE), ie, between 0.80 and 1.25, for the MACE or Bleeding outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the MACE outcome. Results to the left
(left lower half table) correspond to the Bleeding outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is within the ROPE.

\newpage

## eFigure 5: Ranks and SUCRA

```{r}
p1 = 
  multinma::posterior_rank_probs(network_MACE_not_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "MACE") |> 
  dplyr::bind_rows(
    posterior_rank_probs(network_safety_not_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "Bleeding")
  ) |> 
  dplyr::mutate(
    parameter = dplyr::case_when(
      parameter == "d[AAS]" ~ "ASA",
      parameter == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      parameter == "d[60_Ticagrelor]" ~ "Ticagrelor 60mg",
      parameter == "d[90_Ticagrelor]" ~ "Ticagrelor 90mg",
      parameter == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      parameter == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      parameter == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      parameter == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg"),
    
    parameter = factor(parameter, levels = c("ASA + Prasugrel 10mg",
                                     "Clopidogrel 75mg",
                                     "ASA + Rivaroxaban 2.5mg",
                                     "ASA + Clopidogrel 75mg",
                                     "Ticagrelor 60mg",
                                     "Ticagrelor 90mg",
                                     "Rivaroxaban 5mg",
                                     "ASA")),
    
    Outcome = factor(Outcome, levels = c("MACE", "Bleeding"))
    ) |> 
  # pivot_longer code below extracted from 
  # https://github.com/dmphillippo/multinma/blob/HEAD/R/nma_summary-class.R
  
  tidyr::pivot_longer(cols = dplyr::starts_with("p_rank"),
                      names_to = "rank", values_to = "probability",
                      names_pattern = "^p_rank\\[([0-9]+)\\]$",
                      names_transform = list(rank = as.integer)) |> 
  dplyr::mutate(probability = 100*probability) |> 
  ggplot() + 
  aes(x = rank, y = probability, group = Outcome, color = Outcome,
      linetype = Outcome) +
  geom_line(size = 0.9) +
  scale_color_manual(values = c("#5CA881", "#802521")) +
  scale_x_continuous(breaks = seq(1, 7, 1)) +
  scale_y_continuous(breaks = seq(0, 100, 50),
                     limits = c(0, 110)) +
  labs(x = "Rank", y = "Probability (%)\n") +
  facet_wrap(~parameter, nrow = 3) +
  multinma::theme_multinma()

```

```{r}
mace_sucra = 
  multinma::posterior_rank_probs(network_MACE_not_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "MACE")

safety_sucra = 
  multinma::posterior_rank_probs(network_safety_not_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "Bleeding")

p2 = 
  dplyr::bind_rows(mace_sucra, safety_sucra) |> 
  dplyr::mutate(
    parameter = dplyr::case_when(
      parameter == "d[AAS]" ~ "ASA",
      parameter == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      parameter == "d[60_Ticagrelor]" ~ "Ticagrelor 60mg",
      parameter == "d[90_Ticagrelor]" ~ "Ticagrelor 90mg",
      parameter == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      parameter == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      parameter == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      parameter == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg"),
    
    parameter = factor(parameter, levels = rev(c("ASA + Prasugrel 10mg",
                                     "Clopidogrel 75mg",
                                     "ASA + Rivaroxaban 2.5mg",
                                     "ASA + Clopidogrel 75mg",
                                     "Ticagrelor 60mg",
                                     "Ticagrelor 90mg",
                                     "Rivaroxaban 5mg",
                                     "ASA"))),
    outcome = factor(outcome, levels = c("MACE", "Bleeding"))
    ) |> 
  ggplot() +
  aes(y = parameter, x = outcome, fill = sucra, label = sucra) +
  geom_tile() +
  geom_text(size = 4,
            aes(color = sucra > 0.6),
            show.legend = F) +
  scale_color_manual(values = c("black", "white")) +
  scale_fill_gradientn("SUCRA",
                       breaks=c(0, 0.50, 1),
                       limits = c(-0.1, 1.1),
                       colors = MetBrewer::met.brewer("OKeeffe2")) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  labs(x = NULL, y = NULL) +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
```

```{r, fig.width = 11, fig.height = 5}
# Show both plots together
p1 + p2 + patchwork::plot_annotation(tag_levels = "A") +
  patchwork::plot_layout(widths = c(5, 1))
```

Panel A: Ranking probabilities for MACE (solid line) and Bleeding (dotted line)
outcomes for each treatment.
Panel B: Heatmap with corresponding SUCRA values. While each row corresponds to
a treatment, each column depicts one outcome. 

\elandscape

## eFigure 6: Ranks with Uncertainty 

```{r}
rxp = "^rank\\[(.+)]$" 

ranks_MACE = 
  multinma::posterior_ranks(network_MACE_not_pooled_FE, lower_better = T,
                          summary = F)

ranks_safety = 
  multinma::posterior_ranks(network_safety_not_pooled_FE, lower_better = T,
                          summary = F)

ranks_MACE$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "MACE") |> 
  dplyr::bind_rows(
    ranks_safety$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "Bleeding")
  ) |> 
  dplyr::mutate(
    name = dplyr::case_when(
      name == "AAS" ~ "ASA",
      name == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      name == "60_Ticagrelor" ~ "Ticagrelor 60mg",
      name == "90_Ticagrelor" ~ "Ticagrelor 90mg",
      name == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      name == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      name == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      name == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg"),
    
    name = factor(name, levels = rev(c("ASA + Prasugrel 10mg",
                                     "Clopidogrel 75mg",
                                     "ASA + Rivaroxaban 2.5mg",
                                     "ASA + Clopidogrel 75mg",
                                     "Ticagrelor 60mg",
                                     "Ticagrelor 90mg",
                                     "Rivaroxaban 5mg",
                                     "ASA"))),
    outcome = factor(outcome, levels = c("MACE",
                                         "Bleeding"))) |> 
  
  ggplot() +
  aes(x = value, y = name, fill = name) +
  ggdist::stat_cdfinterval(.width = 0.95,
                       point_interval = ggdist::median_qi) +
  scale_fill_manual(values= MetBrewer::met.brewer("Greek", 8)) +
  scale_x_continuous(breaks = seq(1, 8, 1)) +
  labs(x = "Rank", y = NULL) +
  facet_wrap(~outcome, scales = "free_x") +
  multinma::theme_multinma() +
  theme(legend.position = "none")


```

Marginal posterior distributions for the rank of each treatment. Left panel depicts
ranks for MACE, while right panel for the Bleeding outcome. In each panel,
there are a point estimate, interval bar, and bar plot for each treatment (Y-axis).
The point estimate represents the median rank. The interval bar shows the 95% 
credible interval of the underlying marginal posterior distribution. Lastly,
the bar plot shows the cumulative distribution function (CDF).  

\newpage


# Pooled Ticagrelor Networks: Secondary Outcomes

## eFigure 7: Network Plots

\textbf{Acute Myocardial Infarction}

```{r}
net_fun(subset(data, outcome == "AMI_pooled"))

```

\textbf{Ischemic Stroke, All-cause Mortality, and Cardiovascular Mortality}

```{r}
net_fun(subset(data, outcome == "stroke_pooled"))
# net_fun(subset(data, outcome == "cardio_death_pooled")) same network
# net_fun(subset(data, outcome == "any_death_pooled")) same network
```

\newpage


## eFigure 8: Forest Plot

```{r message=FALSE, warning=FALSE, results=FALSE}
wrangle_forest_fun = function(network_object,
                              outcome_name){
  
sucra = 
  multinma::posterior_rank_probs(network_object, 
                                 lower_better = T,
                                 sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::rename("name" = parameter)

draws = multinma::relative_effects(network_object,
                                   summary = F)

draws_pivot = 
  draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d["))

CIs = 
  draws_pivot |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::select(name:.upper) |> 
  dplyr::mutate(interval = paste0(round(exp(value),2),
                                  " [",
                                  round(exp(.lower), 2),
                                  ", ",
                                  round(exp(.upper), 2),
                                  "]")
  )

probs = 
  draws_pivot |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr08 = mean(value < log(0.8)),
                   pr1_lower = mean(value < log(1)),
                   pr1_greater = mean(value > log(1)),
                   pr125 = mean(value > log(1/0.8)),
                   prrope = mean(value > log(0.8) & value < log(1/0.8))) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(dplyr::across(pr08:prrope, ~round(100*.,1)))


both = 
  dplyr::left_join(CIs, sucra) |>
  dplyr::left_join(probs) |>
  dplyr::mutate(
    name = dplyr::case_when(
      name == "d[AAS]" ~ "ASA",
      name == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      name == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      name == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      name == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      name == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg",
      name == "d[Pooled_Ticagrelor]" ~ "Pooled Ticagrelor"),
    
    outcome = outcome_name
    )

return(both)
}

altogether = 
  wrangle_forest_fun(network_AMI_pooled_FE,
                   outcome_name = "AMI") |> 
  dplyr::bind_rows(
    wrangle_forest_fun(network_Isch_Stroke_pooled_FE,
                       outcome_name = "Stroke"),
    wrangle_forest_fun(network_Any_Death_pooled_FE,
                       outcome_name = "Any Death"),
     wrangle_forest_fun(network_Cardio_Death_pooled_FE,
                       outcome_name = "Cardiovascular Death")
    ) |> 
  dplyr::mutate(
    outcome = factor(outcome, levels = rev(c("AMI",
                                         "Stroke",
                                         "Any Death",
                                         "Cardiovascular Death")))
  ) |> 
  dplyr::arrange(sucra)
  
forest_fun = function(){
  
   x = 
     base::with(altogether,
              metafor::forest(
                x = value,
                ci.lb = .lower,
                ci.ub = .upper,
                ylim = c(-2, 26),
                rows= c(-2:1, 4:7, 10:13, 16:21),
                xlim = c(-3, 4),
                ilab = cbind(interval, pr08, pr1_lower,
                             pr1_greater, pr125, prrope),
                ilab.xpos = 1+c(0.6, 1.2, 1.5, 1.8, 2.1, 2.4),
                slab = name,
                order = outcome,
                at=log(c(.2, .4, .6, 0.8, 1, 1.25, 2, 3)),
                refline = log(c(0.8, 1, 1/0.8)), # vertical lines
                pch = 19, # circles
                annotate = F, # Remove estimates
                atransf = exp,
                psize = 1.4, # Circle size
                efac=0, # Remove vertical lines at interval bars
                header="Compared with ASA",
                xlab = "Hazard Ratio (log scale)",
                cex = 1,
                cex.lab = 1) # X axis label font size
  ) 

# ROPE
graphics::rect(xleft = log(0.8), xright = log(1/0.8),
               ybottom = x$ylim[1] - 2, ytop = x$ylim[2] - 2,
               border = NA, # no borders
               col = grDevices::adjustcolor("gray70", alpha.f = 0.4))

# Headers

text(x$xlim[1], x$ylim[2] - 3.5,
     "AMI",
     pos = 4, # left-align
     font= 4, # bold
     cex = 1.3)

text(x$xlim[1], x$ylim[2] - 11.5,
     pos = 4, # left-align
     "Stroke",
     font=4, # bold
     cex = 1.3)

text(x$xlim[1], x$ylim[2] - 17.5,
     "All-cause Mortality",
     pos = 4, # left-align
     font=4, # bold
     cex = 1.3)

text(x$xlim[1], x$ylim[2] - 23.5,
     "Cardiovascular Mortality",
     pos = 4, # left-align
     font=4, # bold
     cex = 1.3)

text((3.55 + 2.05)/2,
     x$ylim[2], 
     "Posterior Probability, %",
     #font=2,
     cex = 1)

# Horizontal line
segments(x0 = 2.05, x1 = 3.55,
         y0 = x$ylim[2] - 0.5, y1 = x$ylim[2] - 0.5)

graphics::text(1+c(0.6, 1.2, 1.5, 1.8, 2.1, 2.4),
               x$ylim[2] - 1, cex = 1,
               c("HR [95% CrI]", "< 0.80", "< 1.00",
                 "> 1.00", "> 1.25", "ROPE"))
}

pdf(file = here::here("output", "plots", "supplementary",
                      'forest_secondary_outcomes.pdf'),
    height=11, width=12)

forest_fun()

dev.off()
```

```{r out.width="1.1\\linewidth"}
# Show previously saved forest plot
knitr::include_graphics(here::here("output", "plots", "supplementary",
                                   "forest_secondary_outcomes.png"))

```


Treatment effects compared to ASA on MACE and Bleeding outcomes, ordered according
to underlying SUCRA values. HR below 1.0 favors the experimental treatment.
On the left, treatment names are depicted. In the middle,
forest plot shows each treatment effect median and 95% credible intervals. Gray
area corresponds to the ROPE (from 0.8 to 1.25 HR). On the right, exact effect
sizes along with posterior probabilities are shown.

Abbreviations: ROPE, region of practical equivalence; HR, hazard ratio.

\newpage


\blandscape

## League Tables

### eTables 13-15: Median and 95% Credible Intervals

```{r fig.height=5}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

AMI_draws = multinma::relative_effects(network_AMI_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

AMI_matrix = 
  AMI_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = AMI_matrix[upper.tri(AMI_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7),
                  caption = "Acute Myocardial Infarction") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Hazard ratios (95% credible interval) for the Acute Myocardial Infarction outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).


\elandscape


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

stroke_draws = multinma::relative_effects(network_Isch_Stroke_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

stroke_matrix = 
  stroke_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = stroke_matrix[upper.tri(stroke_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "Ischemic Stroke") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Hazard ratios (95% credible interval) for the Ischemic Stroke outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

any_draws = multinma::relative_effects(network_Any_Death_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

cardio_draws = multinma::relative_effects(network_Cardio_Death_pooled_FE,
                               summary = F,
                               all_contrasts = T)

any_matrix = 
  any_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


cardio_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  cardio_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  ggdist::median_hdi(.width = 0.95) |> 
  dplyr::mutate(dplyr::across(value:.upper, ~round(exp(.), 2))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   estci =  base::sprintf("%.2f (%.2f, %.2f)",
                                         value, .lower, .upper)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = estci) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 4))
  )
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = any_matrix[upper.tri(any_matrix)]
new[lower.tri(new)] = cardio_matrix[lower.tri(cardio_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "All-cause and Cardiovascular Mortality") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Hazard ratios (95% credible interval) for the All-cause or Cardiovascular
mortality outcomes. Treatments are shown in the diagonal. Results to the right
of this diagonal (right upper half table) correspond to the All-cause mortality
outcome. Results to the left (left lower half table) correspond to the
Cardiovascular mortality outcome. Comparisons between treatments should be read
from left to right and the estimate is in the cell in common between the
column-defining treatment and the row-defining treatment. For both outcomes, a
hazard ratio < 1.0 favors the column-defining treatment. For example, in the
Rivaroxaban 5mg vs. ASA comparison for All-cause mortality, the corresponding
HR (95% CrI) was `r new[1,2]`, favoring Rivaroxaban 5mg (ie, HR < 1.0).

\newpage


\blandscape


### eTables 16-18: Posterior Probabilities of Hazard Ratio < 1.0

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

AMI_draws = multinma::relative_effects(network_AMI_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

AMI_matrix = 
  AMI_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = AMI_matrix[upper.tri(AMI_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7),
                  caption = "Acute Myocardial Infarction") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 1.0 for the Acute Myocardial
Infarction outcome. Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 1.0 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).


\elandscape


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

stroke_draws = multinma::relative_effects(network_Isch_Stroke_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

stroke_matrix = 
  stroke_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = stroke_matrix[upper.tri(stroke_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "Ischemic Stroke") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 1.0 for the Ischemic Stroke outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 1.0 (ie,
there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

any_draws = multinma::relative_effects(network_Any_Death_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

cardio_draws = multinma::relative_effects(network_Cardio_Death_pooled_FE,
                               summary = F,
                               all_contrasts = T)

any_matrix = 
  any_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


cardio_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  cardio_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 4))
  )
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = any_matrix[upper.tri(any_matrix)]
new[lower.tri(new)] = cardio_matrix[lower.tri(cardio_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "All-cause and Cardiovascular Mortality") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 1.0 for the All-cause or
Cardiovascular mortality outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the All-cause mortality outcome. Results to the left
(left lower half table) correspond to the Cardiovascular mortality outcome.
Comparisons between treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for All-cause mortality,
there was a posterior probability of `r new[1,2]`% that the hazard ratio is below
1.0 (ie, there was a `r new[1,2]`% probability for Rivaroxaban 5mg superiority).

\newpage


\blandscape

### eTables 19-21: Posterior Probabilities of Hazard Ratio < 0.8

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

AMI_draws = multinma::relative_effects(network_AMI_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

AMI_matrix = 
  AMI_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = AMI_matrix[upper.tri(AMI_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7),
                  caption = "Acute Myocardial Infarction") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 0.80 for the Acute Myocardial
Infarction outcome. Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 0.80.


\elandscape


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

stroke_draws = multinma::relative_effects(network_Isch_Stroke_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

stroke_matrix = 
  stroke_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = stroke_matrix[upper.tri(stroke_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "Ischemic Stroke") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 0.80 for the Ischemic Stroke outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
A hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is below 0.80.

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

any_draws = multinma::relative_effects(network_Any_Death_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

cardio_draws = multinma::relative_effects(network_Cardio_Death_pooled_FE,
                               summary = F,
                               all_contrasts = T)

any_matrix = 
  any_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


cardio_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  cardio_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(0.8))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 4))
  )
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = any_matrix[upper.tri(any_matrix)]
new[lower.tri(new)] = cardio_matrix[lower.tri(cardio_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "All-cause and Cardiovascular Mortality") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio < 0.80 for the All-cause or
Cardiovascular mortality outcomes.
Treatments are shown in the diagonal. Results to the right of this diagonal
(right upper half table) correspond to the All-cause mortality outcome. Results to the left
(left lower half table) correspond to the Cardiovascular mortality outcome.
Comparisons between treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for All-cause mortality,
there was a posterior probability of `r new[1,2]`% that the hazard ratio is below
0.80.

\newpage


\blandscape

### eTables 22-24: Posterior Probabilities of Hazard Ratio > 1.25

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

AMI_draws = multinma::relative_effects(network_AMI_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

AMI_matrix = 
  AMI_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = AMI_matrix[upper.tri(AMI_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7),
                  caption = "Acute Myocardial Infarction") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio > 1.25 for the Acute Myocardial
Infarction outcome. Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is above 1.25.


\elandscape


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

stroke_draws = multinma::relative_effects(network_Isch_Stroke_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

stroke_matrix = 
  stroke_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = stroke_matrix[upper.tri(stroke_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "Ischemic Stroke") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio > 1.25 for the Ischemic Stroke outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is above 1.25.


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

any_draws = multinma::relative_effects(network_Any_Death_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

cardio_draws = multinma::relative_effects(network_Cardio_Death_pooled_FE,
                               summary = F,
                               all_contrasts = T)

any_matrix = 
  any_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


cardio_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  cardio_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 4))
  )
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = any_matrix[upper.tri(any_matrix)]
new[lower.tri(new)] = cardio_matrix[lower.tri(cardio_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "All-cause and Cardiovascular Mortality") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio > 1.25 for the All-cause or
Cardiovascular mortality outcomes. Treatments are shown in the diagonal.
Results to the right of this diagonal (right upper half table) correspond to
the All-cause mortality outcome. Results to the left (left lower half table)
correspond to the Cardiovascular mortality outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for MACE, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is above 1.25.

\newpage


\blandscape


### eTables 25-27: Posterior Probabilities of Hazard Ratio within the ROPE

```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", 
          "AAS_10_Prasugrel", "AAS_75_Clopidogrel", "Pooled_Ticagrelor")

AMI_draws = multinma::relative_effects(network_AMI_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

AMI_matrix = 
  AMI_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |>  
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 6))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "AAS_10_Prasugrel" = NA,
          "AAS_75_Clopidogrel" = NA,
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 7, ncol = 7)
new[upper.tri(new)] = AMI_matrix[upper.tri(AMI_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg", 
          "ASA + Prasugrel 10mg", "ASA + Clopidogrel 75mg", "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 7),
                  caption = "Acute Myocardial Infarction") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio within the region of practical equivalence
(ROPE), ie, between 0.80 and 1.25, for the Acute Myocardial Infarction outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is within the ROPE.


\elandscape


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

stroke_draws = multinma::relative_effects(network_Isch_Stroke_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

stroke_matrix = 
  stroke_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = stroke_matrix[upper.tri(stroke_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() %>%
  base::replace(is.na(.), " ") |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "Ischemic Stroke") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio within the region of practical equivalence
(ROPE), ie, between 0.80 and 1.25, for the Ischemic Stroke outcome.
Treatments are shown in the diagonal. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison, there was a
posterior probability of `r new[1,2]`% that the hazard ratio is within the ROPE.


```{r}

rxp = "^d\\[(.+) vs\\. (.+)\\]$" 

order = c("AAS", "5_Rivaroxaban", "75_Clopidogrel", "AAS_2.5_Rivaroxaban", "Pooled_Ticagrelor")

any_draws = multinma::relative_effects(network_Any_Death_pooled_FE,
                                        summary = F,
                                        all_contrasts = T)

cardio_draws = multinma::relative_effects(network_Cardio_Death_pooled_FE,
                               summary = F,
                               all_contrasts = T)

any_matrix = 
  any_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value > log(0.8) & value < log(1.25))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  dplyr::bind_cols(
    tibble("AAS" = rep(NA, 4))
  ) |> 
  # re-arrange column order
  dplyr::select(order) |> 
  dplyr::bind_rows(
    tibble("AAS" = NA,
           "5_Rivaroxaban" = NA,
           "75_Clopidogrel" = NA,
           "AAS_2.5_Rivaroxaban" = NA, 
          "Pooled_Ticagrelor" = NA)
  ) |> 
  as.matrix()


cardio_matrix  = 
  data.frame("AAS" = NA,
             "5_Rivaroxaban" = NA,
             "75_Clopidogrel" = NA,
             "AAS_2.5_Rivaroxaban" = NA, 
            "Pooled_Ticagrelor" = NA,
            row.names = "AAS") |> 
  dplyr::rename("5_Rivaroxaban" = X5_Rivaroxaban,
                "75_Clopidogrel" = X75_Clopidogrel) |> 
  dplyr::bind_rows(
    
  cardio_draws$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("d[")) |> 
  dplyr::group_by(name) |> 
  dplyr::summarise(pr = 100*mean(value < log(1))) |> 
  dplyr::transmute(trtb = base::gsub(rxp, "\\1", name),
                   trta = base::gsub(rxp, "\\2", name),
                   prob =  base::sprintf("%.2f",
                                         pr)) |> 
  dplyr::mutate(trtb = factor(trtb, levels = order)) |> 
  dplyr::arrange(trtb) |> 
  tidyr::pivot_wider(names_from = trtb,
                     values_from = prob) |> 
  dplyr::rename(" " = trta) |> 
  t() |> 
  data.frame() |>
  # https://stackoverflow.com/questions/32054368/use-first-row-data-as-column-names-in-r
  janitor::row_to_names(row_number = 1) |> 
  dplyr::bind_cols(
    data.frame("Pooled_Ticagrelor" = rep(NA, 4))
  )
  ) |> 
  as.matrix()

# https://stackoverflow.com/questions/38031892/combine-upper-tri-and-lower-tri-matrices-into-a-single-data-frame

new = matrix(NA, nrow = 5, ncol = 5)
new[upper.tri(new)] = any_matrix[upper.tri(any_matrix)]
new[lower.tri(new)] = cardio_matrix[lower.tri(cardio_matrix)]

ttnames = c("ASA", "Rivaroxaban 5mg", "Clopidogrel 75mg", "ASA + Rivaroxaban 2.5mg",  "Pooled Ticagrelor")

# Rename diagonal with treatment names
diag(new) = ttnames

new |> 
  data.frame() |> 
  kableExtra::kbl(booktabs = T, col.names	= rep(" ", 5),
                  caption = "All-cause and Cardiovascular Mortality") |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
```

Posterior probabilities (%) of hazard ratio within the region of practical
equivalence (ROPE), ie, between 0.80 and 1.25, for the All-cause or
Cardiovascular mortality outcomes. Treatments are shown in the diagonal. Results
to the right of this diagonal (right upper half table) correspond to the
All-cause mortality outcome. Results to the left (left lower half table)
correspond to the Cardiovascular mortality outcome. Comparisons between
treatments should be read from left to right and the estimate is in the cell in
common between the column-defining treatment and the row-defining treatment. 
For both outcomes, a hazard ratio < 1.0 favors the column-defining treatment.
For example, in the Rivaroxaban 5mg vs. ASA comparison for All-cause mortality,
there was a posterior probability of `r new[1,2]`% that the hazard ratio is
within the ROPE.

\newpage


\blandscape

## eFigure 9: Ranks + SUCRA

```{r}
p1 = 
  multinma::posterior_rank_probs(network_AMI_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "AMI") |> 
  dplyr::bind_rows(
    posterior_rank_probs(network_Isch_Stroke_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "Stroke"),
  
  posterior_rank_probs(network_Any_Death_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "All-cause Mortality"),
  
  posterior_rank_probs(network_Cardio_Death_pooled_FE, lower_better = T) |> 
  dplyr::as_tibble() |> 
  dplyr::mutate(Outcome = "Cardiovascular Mortality")
  ) |> 
  dplyr::mutate(
    parameter = dplyr::case_when(
      parameter == "d[AAS]" ~ "ASA",
      parameter == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      parameter == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      parameter == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      parameter == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      parameter == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg",
      parameter == "d[Pooled_Ticagrelor]" ~ "Pooled Ticagrelor"),
    
    parameter = factor(parameter, levels = c("ASA + Prasugrel 10mg",
                                     "Clopidogrel 75mg",
                                     "ASA + Rivaroxaban 2.5mg",
                                     "ASA + Clopidogrel 75mg",
                                     "Pooled Ticagrelor",
                                     "Rivaroxaban 5mg",
                                     "ASA")),
    
    Outcome = factor(Outcome, levels = c("AMI", "Stroke",
                                         "All-cause Mortality",
                                         "Cardiovascular Mortality"))
    ) |> 
  # pivot_longer code below extracted from 
  # https://github.com/dmphillippo/multinma/blob/HEAD/R/nma_summary-class.R
  
  tidyr::pivot_longer(cols = dplyr::starts_with("p_rank"),
                      names_to = "rank", values_to = "probability",
                      names_pattern = "^p_rank\\[([0-9]+)\\]$",
                      names_transform = list(rank = as.integer)) |> 
  dplyr::mutate(probability = 100*probability) |> 
  ggplot() + 
  aes(x = rank, y = probability, group = Outcome, color = Outcome) +
  geom_line(size = 0.9) +
  scale_color_manual(values = MetBrewer::met.brewer("Egypt", 4)) +
  scale_x_continuous(breaks = seq(1, 7, 1)) +
  scale_y_continuous(breaks = seq(0, 100, 50),
                     limits = c(0, 110)) +
  labs(x = "Rank", y = "Probability (%)\n") +
  facet_wrap(~parameter, nrow = 3) +
  multinma::theme_multinma() +
  # https://stackoverflow.com/questions/62304750/ignore-x-label-alignment-with-multiple-plots-in-patchwork-is-this-possible
  theme(axis.title.x = element_text(margin = margin(t = -80, unit = "pt")),
        legend.position = "bottom",
        legend.margin= margin(t = -60, unit = "pt"))

```

```{r}
ami_sucra = 
  multinma::posterior_rank_probs(network_AMI_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "AMI")

stroke_sucra = 
  multinma::posterior_rank_probs(network_Isch_Stroke_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "Stroke")

any_sucra = 
  multinma::posterior_rank_probs(network_Any_Death_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "All-cause Mortality")

cardio_sucra = 
  multinma::posterior_rank_probs(network_Cardio_Death_pooled_FE, 
                               lower_better = T,
                               sucra = T) |> 
  data.frame() |> 
  dplyr::select(parameter, sucra) |> 
  dplyr::mutate(sucra = round(sucra, 2)) |> 
  dplyr::arrange(desc(sucra)) |> 
  dplyr::mutate(outcome = "Cardiovascular Mortality")

p2 = 
  dplyr::bind_rows(ami_sucra, stroke_sucra, any_sucra, cardio_sucra) |> 
  dplyr::mutate(
    
    parameter = dplyr::case_when(
      parameter == "d[AAS]" ~ "ASA",
      parameter == "d[5_Rivaroxaban]" ~ "Rivaroxaban 5mg",
      parameter == "d[75_Clopidogrel]" ~ "Clopidogrel 75mg",
      parameter == "d[AAS_2.5_Rivaroxaban]" ~ "ASA + Rivaroxaban 2.5mg",
      parameter == "d[AAS_10_Prasugrel]" ~ "ASA + Prasugrel 10mg",
      parameter == "d[AAS_75_Clopidogrel]" ~ "ASA + Clopidogrel 75mg",
      parameter == "d[Pooled_Ticagrelor]" ~ "Pooled Ticagrelor"),
    
    parameter = factor(parameter, levels = rev(c("ASA + Prasugrel 10mg",
                                                 "ASA + Clopidogrel 75mg",
                                                 "Clopidogrel 75mg",
                                                 "Pooled Ticagrelor",
                                                 "ASA + Rivaroxaban 2.5mg",
                                                 "Rivaroxaban 5mg",
                                                 "ASA"))),
    outcome = factor(outcome, levels = c("AMI", "Stroke",
                                         "All-cause Mortality",
                                         "Cardiovascular Mortality"))
    ) |> 
  ggplot() +
  aes(y = parameter, x = outcome, fill = sucra, label = sucra) +
  geom_tile() +
  geom_text(size = 4,
            aes(color = sucra > 0.6),
            show.legend = F) +
  scale_color_manual(values = c("black", "white")) +
  scale_fill_gradientn("SUCRA",
                       breaks=c(0, 0.50, 1),
                       limits = c(-0.1, 1.1),
                       colors = MetBrewer::met.brewer("OKeeffe2")) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  labs(x = NULL, y = NULL) +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle=90, vjust=.5, hjust=1),
        panel.background = element_rect(fill = "white"))
```

```{r fig.width = 11, fig.height = 6}
p1 + p2 + patchwork::plot_annotation(tag_levels = "A") +
  patchwork::plot_layout(widths = c(4, 2))
```

Panel A: Ranking probabilities for Acute Myocardical Infarction (AMI),
Stroke, All-cause and Cardiovascular Mortality outcomes for each treatment. There
are only AMI rankings for "ASA + Prasugrel 10mg" and "ASA + Clopidogrel 75mg"
because there was no data available for other outcomes in corresponding studies.
Panel B: Heatmap with corresponding SUCRA values. While each row corresponds to
a treatment, each column depicts one outcome. 


\elandscape

## eFigure 10: Ranks with Uncertainty

```{r fig.width = 10}
rxp = "^rank\\[(.+)]$" 

ranks_AMI = 
  multinma::posterior_ranks(network_AMI_pooled_FE, lower_better = T,
                          summary = F)

ranks_stroke = 
  multinma::posterior_ranks(network_Isch_Stroke_pooled_FE, lower_better = T,
                          summary = F)

ranks_any = 
  multinma::posterior_ranks(network_Any_Death_pooled_FE, lower_better = T,
                          summary = F)

ranks_cardio = 
  multinma::posterior_ranks(network_Cardio_Death_pooled_FE, lower_better = T,
                          summary = F)

ranks_AMI$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "AMI") |> 
  dplyr::bind_rows(
    ranks_stroke$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "Stroke"),
  
  ranks_any$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "All-cause Mortality"),
  
  ranks_cardio$sims |> 
  posterior::as_draws_df() |> 
  tidyr::pivot_longer(dplyr::starts_with("rank[")) |> 
  dplyr::mutate(name = base::gsub(rxp, "\\1", name)) |> 
  dplyr::mutate(outcome = "Cardiovascular Mortality"),
  ) |> 
  dplyr::mutate(
     name = dplyr::case_when(
      name == "AAS" ~ "ASA",
      name == "5_Rivaroxaban" ~ "Rivaroxaban 5mg",
      name == "75_Clopidogrel" ~ "Clopidogrel 75mg",
      name == "AAS_2.5_Rivaroxaban" ~ "ASA + Rivaroxaban 2.5mg",
      name == "AAS_10_Prasugrel" ~ "ASA + Prasugrel 10mg",
      name == "AAS_75_Clopidogrel" ~ "ASA + Clopidogrel 75mg",
      name == "Pooled_Ticagrelor" ~ "Pooled Ticagrelor"),
    
    name = factor(name, levels = rev(c("ASA + Prasugrel 10mg",
                                                 "ASA + Clopidogrel 75mg",
                                                 "Clopidogrel 75mg",
                                                 "Pooled Ticagrelor",
                                                 "ASA + Rivaroxaban 2.5mg",
                                                 "Rivaroxaban 5mg",
                                                 "ASA"))),
    outcome = factor(outcome, levels = c("AMI", "Stroke",
                                         "All-cause Mortality",
                                         "Cardiovascular Mortality"))) |> 
  
  ggplot() +
  aes(x = value, y = name, fill = name) +
  ggdist::stat_cdfinterval(.width = 0.95,
                       point_interval = ggdist::median_qi) +
  scale_fill_manual(values= MetBrewer::met.brewer("Greek", 8)) +
  scale_x_continuous(breaks = seq(1, 8, 1)) +
  labs(x = "Rank", y = NULL) +
  facet_wrap(~outcome, nrow = 1, scales = "free_x") +
  multinma::theme_multinma() +
  theme(legend.position = "none")


```

Marginal posterior distributions for the rank of each treatment. Each panel 
corresponds to a separate outcome, labeled on top. In each panel,
there are a point estimate, interval bar, and bar plot for each treatment (Y-axis).
The point estimate represents the median rank. The interval bar shows the 95%
credible (quantile) interval of the underlying marginal posterior distribution.
Lastly, the bar plot shows the cumulative distribution function (CDF).  

\newpage


\blandscape

# CINeMA

```{r}
cinema = rio::import(here::here("data", "cinema.xlsx")) 

cinema = 
  cinema |> 
  
  dplyr::mutate(
  # "4 levels of confidence of the GRADE approach: 
  #  very low, low, moderate, or high"
      
  # "One may start at high confidence and drop the level of confidence by 1 step
  # for each domain with some concerns, and by 2 levels for each domain with
  # major concerns"
  # from DOI: 10.1371/journal.pmed.1003082
  
  "Overall rating" = "High",
  
  "Overall rating" = dplyr::case_when(
    Incoherence == "Major concerns" ~ "Low"),
  
  "Overall rating" = dplyr::case_when(
    Imprecision == "No concerns" ~ "Low",
    Imprecision == "Some concerns" ~ "Very Low",
    Imprecision == "Major concerns" ~ "Very Low"),
  )

# Customize colors

# https://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf

cinema$`Within-study bias` = kableExtra::cell_spec(
  cinema$`Within-study bias`,
  color = "white",
  background = ifelse(cinema$`Within-study bias` == "Some concerns",
                      "#E7B03C", "#5CA881")
)

cinema$`Reporting bias` = kableExtra::cell_spec(
  cinema$`Reporting bias`,
  color = "white",
  background = ifelse(cinema$`Reporting bias` == "Suspected",
                      "#E7B03C", "#5CA881")
)

cinema$`Indirectness` = kableExtra::cell_spec(
  cinema$`Indirectness`,
  color = "white",
  background = ifelse(cinema$`Indirectness` == "No concerns",
                      "#5CA881", "#E7B03C")
)

cinema$`Imprecision` = kableExtra::cell_spec(
  cinema$`Imprecision`,
  color = "white",
  background = ifelse(cinema$`Imprecision` == "No concerns",
                      "#5CA881", 
                      ifelse(cinema$`Imprecision` == "Some concerns",
                             "#E7B03C", "#EA4025"))
)

cinema$`Heterogeneity` = kableExtra::cell_spec(
  cinema$`Heterogeneity`,
  background = "#B5B5B5")

cinema$`Incoherence` = kableExtra::cell_spec(
  cinema$`Incoherence`,
  color = "white",
  background = ifelse(cinema$`Incoherence` == "No concerns",
                      "#5CA881", "#EA4025")
)

cinema$`Overall rating` = kableExtra::cell_spec(
  cinema$`Overall rating`,
  color = "white",
  background = ifelse(cinema$`Overall rating` == "Low",
                      "#EA4025", "#A32A31")
)

# Create function to automate tables

tab_fun = function(network, name){
  
cinema |> 
  dplyr::filter(`Network type` == network &
                Outcome == name) |> 
  dplyr::select(-c(1:2)) |> 
  kableExtra::kbl(booktabs = T, escape = F) |> 
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"))
  
}
```

## eTables 28-33: Pooled Ticagrelor Networks

### MACE

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "MACE")
```

\newpage

### Bleeding

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "Safety")
```

\newpage

### Acute Myocardial Infarction

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "AMI")
```

\newpage

### Ischemic Stroke

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "Ischemic Stroke")
```

### All-cause Mortality

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "All-cause Mortality")
```

\newpage

### Cardiovascular Mortality

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "Cardiovascular Mortality")
```

\newpage

## eTables 34-35: Separate Dosages Ticagrelor Networks

### MACE

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "MACE")
```

\newpage

### Bleeding

```{r}
tab_fun(network = "Pooled Ticagrelor",
        name = "Safety")
```

\elandscape
